#!/usr/bin/env python3
import os
import argparse
import struct
import binascii
import platform
import sys

class androidboot:
    magic="ANDROID!" #BOOT_MAGIC_SIZE 8
    kernel_size=0
    kernel_addr=0
    ramdisk_size=0
    ramdisk_addr=0
    second_addr=0
    second_size=0
    tags_addr=0
    page_size=0
    qcdt_size=0
    os_version=0
    name="" #BOOT_NAME_SIZE 16
    cmdline="" #BOOT_ARGS_SIZE 512
    id=[] #uint*8
    extra_cmdline="" #BOOT_EXTRA_ARGS_SIZE 1024

def getheader(inputfile):
    param = androidboot()
    with open(inputfile, 'rb') as rf:
        header = rf.read(0x660)
        fields = struct.unpack('<8sIIIIIIIIII16s512s8I1024s', header)
        param.magic = fields[0]
        param.kernel_size = fields[1]
        param.kernel_addr = fields[2]
        param.ramdisk_size = fields[3]
        param.ramdisk_addr = fields[4]
        param.second_size = fields[5]
        param.second_addr = fields[6]
        param.tags_addr = fields[7]
        param.page_size = fields[8]
        param.qcdt_size = fields[9]
        param.os_version = fields[10]
        param.name = fields[11]
        param.cmdline = fields[12]
        param.id = [fields[13],fields[14],fields[15],fields[16],fields[17],fields[18],fields[19],fields[20]]
        param.extra_cmdline = fields[21]
    return param

def int_to_bytes(x):
    return x.to_bytes((x.bit_length() + 7) // 8, 'big')
    
def main(arg):
    print("\nMakeramdisk Android Generic v1.4 (c) B. Kerler 2018, Email: bjoern@kerler.re")
    print("------------------------------------------------------------\n")
    if len(arg)!=2:
        print("Usage: makeramdisk.py [inputfile] [outputfile]")
        exit()
    busybox=os.path.join("root","scripts","busybox")+" ash "
    Linux=False
    if platform.system()=="Windows":
        print("Windows detected.")
    else:
        print("Linux/Mac detected.")
        busybox=""
        Linux=True
        
    fake=None
    if ".lz4" in arg[0]:
        print("Compressed lz4 boot detected, unpacking.")
        fn=os.path.join("root","scripts","lz4",arg[0])
        os.system(fn)
    try:
        with open(arg[0],"rb") as rf:
            data=rf.read()
            try:
                param=getheader(arg[0])
                kernelsize = int((param.kernel_size + param.page_size - 1) / param.page_size) * param.page_size
                ramdisksize = int((param.ramdisk_size + param.page_size - 1) / param.page_size) * param.page_size
                secondsize = int((param.second_size + param.page_size - 1) / param.page_size) * param.page_size
                qcdtsize = int((param.qcdt_size + param.page_size - 1) / param.page_size) * param.page_size
                length=param.page_size+kernelsize+ramdisksize+secondsize+qcdtsize
                fake=data[length:]
                fake=fake[0:(int(fake[2])<<8)+int(fake[3])]
            except:
                fake=None
    except:
        print("Couldn't find "+arg[0]+", aborting.")
        exit(1)
    
    scriptpath="root/scripts/patchit.sh"
   
    idx=data.find(b"aarch64")
    if (idx!=-1):
        print("64Bit detected")
        os.system(busybox+scriptpath+" "+arg[0]+" "+arg[1]+".patched 64Bit")
    else:
        print("32Bit detected")
        os.system(busybox+scriptpath+" "+arg[0]+" "+arg[1]+".patched 32Bit")

    if fake!=None:
        if os.path.exists(arg[1]+".patched.signed"):
                os.rename(arg[1]+".patched.signed",arg[1]+".signed")
                param=getheader(arg[1]+".signed")
                kernelsize = int((param.kernel_size + param.page_size - 1) / param.page_size) * param.page_size
                ramdisksize = int((param.ramdisk_size + param.page_size - 1) / param.page_size) * param.page_size
                secondsize = int((param.second_size + param.page_size - 1) / param.page_size) * param.page_size
                qcdtsize = int((param.qcdt_size + param.page_size - 1) / param.page_size) * param.page_size
                length=param.page_size+kernelsize+ramdisksize+secondsize+qcdtsize
                print("- Creating rot fake with length 0x%08X" % length)
                with open(arg[1]+".signed","rb") as rf:
                    rdata=rf.read()
                    rdata=rdata[:length]
                    with open(arg[1]+".rotfake","wb") as wb:
                        wb.write(rdata)
                        wb.write(fake)

if __name__ == '__main__':
    main(sys.argv[1:])